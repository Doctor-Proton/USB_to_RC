<!DOCTYPE html>
<html>
<body>

  <h4>The ESP32 Update web page without refresh</h4><br>
  <div id="varblock"></div><br>
<table>
</table>
</body>
<script>


setInterval(function() {
  // Call a function repetatively with 2 Second interval
  getData();
}, 200); //2000mSeconds update rate


const exprvar ={
	value: 0,
	name: "",
	};
	
var exprvars;

let mountains = [
  { name: "Monte Falco", height: 1658, place: "Parco Foreste Casentinesi" },
  { name: "Monte Falterona", height: 1654, place: "Parco Foreste Casentinesi" },
  { name: "Poggio Scali", height: 1520, place: "Parco Foreste Casentinesi" },
  { name: "Pratomagno", height: 1592, place: "Parco Foreste Casentinesi" },
  { name: "Monte Amiata", height: 1738, place: "Siena" }
];

function generateTableHead(table, data) {
  let thead = table.createTHead();
  let row = thead.insertRow();
  for (let key of data) {
    let th = document.createElement("th");
    let text = document.createTextNode(key);
    th.appendChild(text);
    row.appendChild(th);
  }
}

function generateTable(table, data) {
  for (let element of data) {
    let row = table.insertRow();
    for (key in element) {
      let cell = row.insertCell();
      const text = document.createTextNode(element[key]);
	  if(key=="value")
		{
		var idname=element["name"];
		//console.log("set id", idname);
		cell.id=idname;
		}
	   cell.appendChild(text);
    }
  }
}

function buildTable(input)
{
let table = document.querySelector("table");
let data = Object.keys(input[0]);
generateTableHead(table, data);
generateTable(table, input);
}

var prevLength=0;
console.log(location.hostname);

function getData() {

	  var varhttp = new XMLHttpRequest();
	  varhttp.responseType="arraybuffer";
	  varhttp.onreadystatechange = function() {
	  if (this.readyState == 4 && this.status == 200) {
		//var l=document.getElementById("varblock");
		//l.innerHTML=this.responseText;
		//console.log(this.response);
		input=new Uint8Array(this.response);
		
		var i=0;
		console.log("got ",input.byteLength, " bytes");
		const texprvar=new Array();
		while(i<input.byteLength)
		{
			//var entry=exprvar;
			const floatbytes = new ArrayBuffer(16);
			const view = new DataView(floatbytes);
			view.setUint8(1,input[i+3]);
			view.setUint8(2,input[i+2]);
			view.setUint8(3,input[i+1]);
			view.setUint8(4,input[i]);
			//console.log(view)
			//console.log(view.getFloat32(1));
			var value=view.getFloat32(1);
			var name="";
			i+=8;
			while(input[i]!=0)
				{
				name+=String.fromCharCode(input[i]);
				i++;
				}
			
			i++;
			//console.log(entry);
			texprvar.push({ name: name, value: value});

		}
		if(prevLength!=texprvar.length)
			{
			buildTable(texprvar);
			}
			else
			{
			for(var j=0;j<texprvar.length;j++)
				{
				var element=texprvar[j].name;
				//console.log("lookup", element);
				var label=document.getElementById(element);
				label.innerHTML=texprvar[j].value;
				}
			}
			
			
		prevLength=texprvar.length;
		console.log(texprvar);

	  }
	  };
	  varurl="http://"+location.hostname+"/vars.bin";
	  varhttp.open("GET", varurl, true);
	  varhttp.send();
}
</script>

</html>
